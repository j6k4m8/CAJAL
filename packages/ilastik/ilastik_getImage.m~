function ilastik_getImage(server, token, queryFile, fileOut, useSemaphore)
% J. Matelsky - adapted from mananno_getImage.m by W. Gray Roncal

if useSemaphore
    oo = OCP('semaphore');
else
    oo = OCP();
end

% Load query
load(queryFile)

oo.setServerLocation(server);
oo.setImageToken(token);
oo.setDefaultResolution(query.resolution);


im = oo.query(query);

tif = Tiff(fileOut, 'a');
tif.setTag('ImageLength', size(im.data, 1));
tif.setTag('ImageWidth', size(im.data, 2));
tif.setTag('Photometric', Tiff.Photometric.RGB);
tif.setTag('BitsPerSample', 8);
tif.setTag('SamplesPerPixel', size(im.data,3));
tif.setTag('TileWidth', 128);
tif.setTag('TileLength', 128);
tif.write(im.data);
tif.close();


%imwrite(im.data, fileOut, 'WriteMode','append');
